{% load static %}
<html>
<head>
    <title>Skill Issue</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header class="header" id="header">
        <nav class="header-container">
            <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
            <div class="nav-group nav-group-left">
                <a class="nav-links" href="{% url 'guides_list' %}" data-lang-ru="руководства" data-lang-en="guides">руководства</a>
                <a class="nav-links" data-lang-ru="объявления" data-lang-en="announcements">объявления</a>
            </div>
            <div class="nav-group nav-group-right">
                <div class="search-container">
                    <input class="search" placeholder="поиск руководств, анкет и профилей" id="searchInput"
                           data-placeholder-ru="поиск руководств, анкет и профилей"
                           data-placeholder-en="search guides, announcements and profiles">
                    <div class="search-dropdown" id="searchDropdown">
                    </div>
                </div>
                <a class="nav-links" data-lang-ru="избранное" data-lang-en="favorites">избранное</a>
                <a class="nav-links" id="language-toggle" href="#" onclick="toggleLanguage(event)" title="Сменить язык">RU</a>
                <div class="menu-container">
                    <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="войти" data-lang-en="log in">войти</a>
                    <div class="context-menu">
                        <a href="{% url 'register_page' %}" data-lang-ru="зарегистрироваться" data-lang-en="register">зарегистрироваться</a>
                        <a href="{% url 'login_page' %}" data-lang-ru="войти" data-lang-en="log in">войти</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="body-background">
        <h1 id="pageTitle" class="simple-text" style="margin-top: 20px; font-size: 1.5rem;"
            data-lang-ru="{% if guide %}Отредактируйте руководство{% else %}Начните создавать своё руководство!{% endif %}"
            data-lang-en="{% if guide %}Edit the guide{% else %}Start creating your guide!{% endif %}">
            {% if guide %}Отредактируйте руководство{% else %}Начните создавать своё руководство!{% endif %}
        </h1>
        <a class="simple-text" style="margin-top: 0; font-size: 0.8rem; color:#424242; margin-bottom: 20px"
           data-lang-ru="Поддерживается разметка текста с помощью markdown"
           data-lang-en="Markdown formatting is supported">
            Поддерживается разметка текста с помощью markdown
        </a>

        <div class="editor-container">
            <input id="titleInput" type="text" class="guide_name_input"
                   placeholder="Введите название руководства"
                   data-placeholder-ru="Введите название руководства"
                   data-placeholder-en="Enter guide title"
                   value="{% if guide %}{{ guide.title|escape }}{% endif %}">
            
            <input id="tagsInput" type="text" class="guide_name_input"
                   placeholder="Введите теги через запятую (например: Python, Django, программирование)"
                   data-placeholder-ru="Введите теги через запятую (например: Python, Django, программирование)"
                   data-placeholder-en="Enter tags separated by commas (e.g. Python, Django, programming)"
                   value="{% if guide %}{{ guide.tags|join:', ' }}{% endif %}"
                   style="margin-top: 10px;">

            <div class="editor-section">
                <div class="editor-header">
                    <div class="toolbar">
                        <button class="toolbar-btn" onclick="insertText('**', '**')" title="Жирный текст" data-lang-ru-title="Жирный текст" data-lang-en-title="Bold">**B**</button>
                        <button class="toolbar-btn" onclick="insertText('*', '*')" title="Курсив" data-lang-ru-title="Курсив" data-lang-en-title="Italic">*I*</button>
                        <button class="toolbar-btn" onclick="insertText('# ', '')" title="Заголовок 1" data-lang-ru-title="Заголовок 1" data-lang-en-title="Heading 1">H1</button>
                        <button class="toolbar-btn" onclick="insertText('## ', '')" title="Заголовок 2" data-lang-ru-title="Заголовок 2" data-lang-en-title="Heading 2">H2</button>
                        <button class="toolbar-btn" onclick="insertText('- ', '')" title="Список" data-lang-ru-title="Список" data-lang-en-title="List">-</button>
                        <button class="toolbar-btn" onclick="insertText('```\n', '\n```')" title="Блок кода" data-lang-ru-title="Блок кода" data-lang-en-title="Code block">```</button>
                        <button class="toolbar-btn" onclick="insertText('> ', '')" title="Цитата" data-lang-ru-title="Цитата" data-lang-en-title="Quote">></button>
                        <input type="file" id="imageInput" class="file-input" accept="image/*" onchange="handleImageUpload()">
                        <label for="imageInput" class="file-label" data-lang-ru="Изображение" data-lang-en="Image">Изображение</label>
                    </div>
                </div>
                <textarea id="markdownEditor"
                          placeholder="Начните писать ваше руководство здесь..."
                          data-placeholder-ru="Начните писать ваше руководство здесь..."
                          data-placeholder-en="Start writing your guide here...">
                    {% if guide %}{{ guide.content|escape }}{% endif %}
                </textarea>
            </div>

            <div class="preview-section">
                <div class="preview-header">
                    <h3 style="line-height: 0; margin-top:5px" data-lang-ru="Предпросмотр" data-lang-en="Preview">Предпросмотр</h3>
                </div>
                <div id="preview" class="preview-content">
                    <em style="color: #666;" data-lang-ru="Предпросмотр появится здесь..." data-lang-en="Preview will appear here...">Предпросмотр появится здесь...</em>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="profile-button" onclick="clearEditor()" data-lang-ru="Очистить" data-lang-en="Clear">Очистить</button>
            <button class="profile-button" onclick="saveGuide()" data-lang-ru="Сохранить руководство" data-lang-en="Save guide">Сохранить руководство</button>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <table class="simple-text" style="width: 100%; height: 100%; color: lightgray; font-size: 1rem">
                <tr>
                    <td colspan="3" style="width:33%;"><a href="https://www.sfu.ru/ru" class="nav-group-left" style="text-decoration: none; color: lightgray; margin-bottom: auto; margin-top: 5px; font-size: 1.25rem "
                           data-lang-ru="Сибирский Федеральный Университет"
                           data-lang-en="Siberian Federal University">Сибирский Федеральный Университет</a>
                    </td>
                    <td style="text-align:right"><p class="nav-group-right" style="margin-bottom: auto; margin-top: 5px; font-size: 1.25rem;">@skill_issue 2025</p>
                    </td>
                </tr>
                <tr>
                    <td><p style="text-align:left">@bukohm</p>
                    </td>
                    <td><p style="text-align:center">@hoolkayyy</p>
                    </td>
                    <td><p style="text-align:right">@K1rkaSs</p>
                    </td>
                </tr>
            </table>
        </div>
    </footer>

<script>
const editor = document.getElementById('markdownEditor');
const preview = document.getElementById('preview');
const titleInput = document.getElementById('titleInput');
const tagsInput = document.getElementById('tagsInput');
const pageTitle = document.getElementById('pageTitle');

const imageStorage = new Map();
let imageCounter = 0;

document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const guideId = urlParams.get('id');

    if (guideId) {
        const lang = localStorage.getItem('lang') || 'RU';
        pageTitle.textContent = lang === 'RU' ? "Отредактируйте руководство" : "Edit the guide";

        fetch(`/api/guides/${guideId}/`)
            .then(response => {
                if (!response.ok) throw new Error('Guide not found');
                return response.json();
            })
            .then(data => {
                titleInput.value = data.title;
                editor.value = data.content;
                if (data.tags && Array.isArray(data.tags)) {
                    tagsInput.value = data.tags.join(', ');
                }

                const imageRegex = /!\[(.*?)\]\((.*?)\)/g;
                let match;
                while ((match = imageRegex.exec(data.content)) !== null) {
                    const altText = match[1];
                    const fileName = match[2];

                    if (!fileName.startsWith("http")) {
                        const imageUrl = `/media/guides/${fileName}`;
                        imageStorage.set(fileName, { url: imageUrl, name: altText || fileName });
                    }
                }

                updatePreview();
            })
            .catch(err => console.error(err));
    }

    updatePreview();
});


function insertText(before, after) {
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const selectedText = editor.value.substring(start, end);
    const newText = editor.value.substring(0, start) + before + selectedText + after + editor.value.substring(end);

    editor.value = newText;
    editor.focus();
    editor.setSelectionRange(start + before.length, end + before.length);

    updatePreview();
}

function handleImageUpload() {
    const fileInput = document.getElementById('imageInput');
    const files = fileInput.files;

    if (files.length > 0) {
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;

                imageStorage.set(file.name, { url: imageUrl, name: file.name, file: file });

                const markdownImage = `![${file.name}](${file.name})`;
                const start = editor.selectionStart;
                const newText = editor.value.substring(0, start) + '\n' + markdownImage + '\n' + editor.value.substring(start);
                editor.value = newText;

                updatePreview();
            };
            reader.readAsDataURL(file);
        });

        fileInput.value = '';
    }
}

function updatePreview() {
    const markdownText = editor.value;
    const html = markdownToHtml(markdownText);
    preview.innerHTML = html;
}

function markdownToHtml(markdown) {
    if (!markdown.trim()) {
        const lang = localStorage.getItem('lang') || 'RU';
        const placeholder = lang === 'RU'
            ? 'Предпросмотр появится здесь...'
            : 'Preview will appear here...';
        return `<em style="color: #666;">${placeholder}</em>`;
    }

    let html = markdown;

    html = html.replace(/!\[(.*?)\]\((.*?)\)/g, (match, alt, path) => {
    if (imageStorage.has(path)) {
        const imageData = imageStorage.get(path);
        return `<img src="${imageData.url}" alt="${alt || imageData.name}" style="max-width:100%;height:auto;margin:10px 0;border:1px solid #ddd;border-radius:5px;">`;
    } else if (!path.startsWith("http")) {
        return `<img src="/media/guides/${path}" alt="${alt}" style="max-width:100%;height:auto;margin:10px 0;border:1px solid #ddd;border-radius:5px;">`;
    }
    return `<img src="${path}" alt="${alt}" style="max-width:100%;height:auto;margin:10px 0;border:1px solid #ddd;border-radius:5px;">`;
});

    html = html.replace(/!\[(.*?)\]\((http[^)]+)\)/g, '<img src="$2" alt="$1" style="max-width:100%;height:auto;margin:10px 0;border:1px solid #ddd;border-radius:5px;">');

    html = html
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/gim, '<em>$1</em>')
        .replace(/\[(.*?)\]\((?!image_)(.*?)\)/gim, '<a href="$2" target="_blank">$1</a>')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
        .replace(/^- (.*$)/gim, '<ul><li>$1</li></ul>')
        .replace(/<\/ul>\s*<ul>/g, '')
        .replace(/\n/g, '<br>');

    return html;
}

function clearEditor() {
    const lang = localStorage.getItem('lang') || 'RU';
    const confirmMsg = lang === 'RU'
        ? 'Вы уверены, что хотите очистить редактор?'
        : 'Are you sure you want to clear the editor?';
    if (confirm(confirmMsg)) {
        editor.value = '';
        titleInput.value = '';
        tagsInput.value = '';
        imageStorage.clear();
        imageCounter = 0;
        updatePreview();
    }
}

async function saveGuide() {
    const guideTitle = titleInput.value.trim();
    const content = editor.value;
    const tags = tagsInput.value.trim();

    const lang = localStorage.getItem('lang') || 'RU';
    const alertMsg = lang === 'RU'
        ? "Введите название и текст"
        : "Please enter title and content";

    if (!guideTitle || !content.trim()) {
        alert(alertMsg);
        return;
    }

    const formData = new FormData();
    formData.append("title", guideTitle);
    formData.append("content", content);
    formData.append("tags", tags);

    for (const [fileName, value] of imageStorage.entries()) {
        if (value.file) {
            formData.append("image", value.file);
        }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const guideId = urlParams.get('id');
    const url = guideId ? `/create_guide/?id=${guideId}` : "{% url 'create_guide' %}";

    const response = await fetch(url, {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    });

    if (response.ok) {
        const successMsg = lang === 'RU'
            ? "Руководство успешно сохранено!"
            : "Guide saved successfully!";
        alert(successMsg);
        window.location.href = guideId ? `/guides/${guideId}/` : "{% url 'guides_list' %}";
    } else {
        const errorMsg = lang === 'RU'
            ? "Ошибка при сохранении руководства"
            : "Failed to save guide";
        alert(errorMsg);
    }
}

editor.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
        e.preventDefault();
        const start = this.selectionStart;
        const end = this.selectionEnd;
        const spaces = '    ';
        this.value = this.value.substring(0, start) + spaces + this.value.substring(end);
        this.selectionStart = this.selectionEnd = start + spaces.length;
        updatePreview();
    }
});

editor.addEventListener('input', updatePreview);
</script>
<script src="{% static 'js/search.js' %}"></script>
<script src="{% static 'js/toggle_language.js' %}"></script>
</body>
</html>