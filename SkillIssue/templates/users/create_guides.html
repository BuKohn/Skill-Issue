{% load static %}
<html>
<head>
    <title>Skill Issue</title>
    <link rel="stylesheet" href="{% static 'css/styles3.css' %}">
</head>
<body>
    <header class="header" id="header">
        <nav class="header-container">
            <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
            <div class="nav-group nav-group-left">
                <a class="nav-links" href="{% url 'guides_list' %}">руководства</a>
                <a class="nav-links">анкеты</a>
            </div>
            <div class="nav-group nav-group-right">
                <input class="search" placeholder="поиск руководств, анкет и профилей"></input>
                <a class="nav-links">избранное</a>
                <div class="menu-container">
                    <a class="nav-links" href="{% url 'login_page' %}">войти</a>
                    <div class="context-menu">
                        <a href="{% url 'register_page' %}">зарегистрироваться</a>
                        <a href="{% url 'login_page' %}">войти</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>
    <div class="body-background">
        <a class="simple-text" style="margin-top: 20px; font-size: 1.5rem;">Начните создавать своё руководство!</a>
        <a class="simple-text" style="margin-top: 0px; font-size: 0.8rem; color:#424242; margin-bottom: 20px">Поддерживается разметка текста с помощью markdown</a>
    <div class="editor-container">
        <input type="text" class="guide_name_input" placeholder="Введите название руководства"></textarea>
      <!-- Редактор -->
        <div class="editor-section">
            <div class="editor-header">
                <div class="toolbar">
                    <button class="toolbar-btn" onclick="insertText('**', '**')" title="Жирный текст">**B**</button>
                    <button class="toolbar-btn" onclick="insertText('*', '*')" title="Курсив">*I*</button>
                    <button class="toolbar-btn" onclick="insertText('# ', '')" title="Заголовок 1">H1</button>
                    <button class="toolbar-btn" onclick="insertText('## ', '')" title="Заголовок 2">H2</button>
                    <button class="toolbar-btn" onclick="insertText('- ', '')" title="Список">-</button>
                    <button class="toolbar-btn" onclick="insertText('```\n', '\n```')" title="Блок кода">```</button>
                    <button class="toolbar-btn" onclick="insertText('> ', '')" title="Цитата">></button>
                    <input type="file" id="imageInput" class="file-input" accept="image/*" onchange="handleImageUpload()">
                    <label for="imageInput" class="file-label">Изображение</label>
                </div>
          </div>
          <textarea id="markdownEditor" placeholder="Начните писать ваше руководство здесь..."></textarea>
        </div>

        <div class="preview-section">
            <div class="preview-header">
                <h3 style="line-height: 0; margin-top:5px">Предпросмотр</h3>
            </div>
            <div id="preview" class="preview-content">
                <em style="color: #666;">Предпросмотр появится здесь...</em>
            </div>
        </div>
    </div>

    <div class="actions">
        <button class="profile-button" onclick="clearEditor()">Очистить</button>
        <button class="profile-button" onclick="saveGuide()">Сохранить руководство</button>
    </div>
    </div>
    <footer class="footer">
        <div class="footer-container">
            <table class="simple-text" style="width: 100%; height: 100%; color: lightgray; font-size: 1rem">
                <tr>
                    <td colspan="3" style="width:33%;"><a href="https://www.sfu.ru/ru" class="nav-group-left" style="text-decoration: none; color: lightgray; margin-bottom: auto; margin-top: 5px; font-size: 1.25rem ">Сибирский Федеральный Университет</a>
                    <td style="text-align:right"><p class="nav-group-right" style="margin-bottom: auto; margin-top: 5px; font-size: 1.25rem;">@skill_issue 2025</p>
                </tr>
                <tr>
                    <td><p style="text-align:left">@bukohm</p>
                    <td><p style="text-align:center">@hoolkayyy</p>
                    <td><p style="text-align:right">@K1rkaSs</p>
                </tr>
            </table>
        </div>
    </footer>
</body>
<script>
    const editor = document.getElementById('markdownEditor');
    const preview = document.getElementById('preview');

    const imageStorage = new Map();
    let imageCounter = 0;

    function insertText(before, after) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const selectedText = editor.value.substring(start, end);
        const newText = editor.value.substring(0, start) + before + selectedText + after + editor.value.substring(end);

        editor.value = newText;
        editor.focus();
        editor.setSelectionRange(start + before.length, end + before.length);

        updatePreview();
    }

    function handleImageUpload() {
        const fileInput = document.getElementById('imageInput');
        const files = fileInput.files;

        if (files.length > 0) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    imageCounter++;

                    const imageKey = `image_${imageCounter}`;
                    imageStorage.set(imageKey, {
                        url: imageUrl,
                        name: file.name
                    });

                    const markdownImage = `![${file.name}](${imageKey})`;

                    const start = editor.selectionStart;
                    const newText = editor.value.substring(0, start) + '\n' + markdownImage + '\n' + editor.value.substring(start);
                    editor.value = newText;

                    updatePreview();
                };
                reader.readAsDataURL(file);
            });

            fileInput.value = '';
        }
    }

    // обновление предпросмотра
    function updatePreview() {
        const markdownText = editor.value;
        const html = markdownToHtml(markdownText);
        preview.innerHTML = html;

    }

    // парсер маркдауна
    function markdownToHtml(markdown) {
        if (!markdown.trim()) {
            return '<em style="color: #666;">Предпросмотр появится здесь...</em>';
        }

        let html = markdown;

        html = html.replace(/!\[(.*?)\]\((image_\d+)\)/g, function(match, alt, imageKey) {
            if (imageStorage.has(imageKey)) {
                const imageData = imageStorage.get(imageKey);
                return `<img src="${imageData.url}" alt="${alt || imageData.name}" style="max-width: 100%; height: auto; display: block; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">`;
            }
            return match;
        });

        html = html.replace(/!\[(.*?)\]\((http[^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%; height: auto; display: block; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">');

        html = html
            // Заголовки
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            // Жирный текст
            .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
            // Курсив
            .replace(/\*(.*?)\*/gim, '<em>$1</em>')
            // Ссылки (но не изображения!)
            .replace(/\[(.*?)\]\((?!image_)(.*?)\)/gim, '<a href="$2" target="_blank">$1</a>')
            // Блоки кода
            .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
            // Строчный код
            .replace(/`(.*?)`/g, '<code>$1</code>')
            // Цитаты
            .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
            // Списки
            .replace(/^- (.*$)/gim, '<ul><li>$1</li></ul>')
            .replace(/<\/ul>\s*<ul>/g, '')
            // Переносы строк
            .replace(/\n/g, '<br>');

        return html;
    }

    // очистка
    function clearEditor() {
        if (confirm('Вы уверены, что хотите очистить редактор?')) {
            editor.value = '';
            imageStorage.clear();
            imageCounter = 0;
            updatePreview();
        }
    }

    // сохранение
    async function saveGuide() {
        const titleInput = document.querySelector('input[type="text"][placeholder="Введите название руководства"]');
        const guideTitle = titleInput.value.trim();
        const content = editor.value;

        if(!guideTitle || !content.trim()) { alert("Введите название и текст"); return; }

        // Формируем FormData
        const formData = new FormData();
        formData.append("title", guideTitle);
        formData.append("content", content);

        const imageFile = document.getElementById('imageInput').files[0];
        if(imageFile) formData.append("image", imageFile);

        // Отправляем POST
        const response = await fetch("{% url 'create_guide' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            },
        });

        if(response.ok){
            alert("Руководство успешно создано!");
            window.location.href = "{% url 'guides_list' %}";
        } else {
            alert("Ошибка при создании руководства");
        }
    }



    // табуляция вместо перемещения по сайту на таб
    editor.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();

            const start = this.selectionStart;
            const end = this.selectionEnd;

            const spaces = '    ';
            this.value = this.value.substring(0, start) + spaces + this.value.substring(end);

            this.selectionStart = this.selectionEnd = start + spaces.length;

            updatePreview();
        }
    });

    editor.addEventListener('input', function() {
        updatePreview();
    });

    document.addEventListener('DOMContentLoaded', function() {
        updatePreview();
        syncHeights();
    });
    updatePreview();
</script>
</html>