{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Skill Issue</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
<header class="header" id="header">
    <nav class="header-container">
        <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
        <div class="nav-group nav-group-left">
            <a class="nav-links" href="{% url 'guides_list' %}" data-lang-ru="руководства" data-lang-en="guides">руководства</a>
            <a class="nav-links" href="#" data-lang-ru="объявления" data-lang-en="announcements">объявления</a>
        </div>
        <div class="nav-group nav-group-right">
            <div class="search-container">
                    <input class="search" placeholder="поиск руководств, анкет и профилей" id="searchInput"
                           data-placeholder-ru="поиск руководств, анкет и профилей"
                           data-placeholder-en="search guides, profiles and announcements">
                    <div class="search-dropdown" id="searchDropdown">
                    </div>
            </div>
            <a class="nav-links" href="#" data-lang-ru="избранное" data-lang-en="favorites">избранное</a>
            <a class="nav-links" id="language-toggle" href="#" onclick="toggleLanguage(event)" title="Сменить язык">RU</a>
            <div id="menu-container" class="menu-container">
                {% if user.is_authenticated %}
                    <a class="nav-links" href="{% url 'logout_page' %}" data-lang-ru="выйти" data-lang-en="log out">выйти</a>
                {% else %}
                    <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="войти" data-lang-en="log in">войти</a>
                    <div class="context-menu">
                        <a href="{% url 'register_page' %}" data-lang-ru="зарегистрироваться" data-lang-en="register">зарегистрироваться</a>
                        <a href="{% url 'login_page' %}" data-lang-ru="войти" data-lang-en="log in">войти</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </nav>
</header>

<div class="body-background">
    <div id="profile-info" class="profile-row-container" data-username="{{ profile.user.username }}">
        {% if profile.avatar %}
            <img src="{{ profile.avatar.url }}" alt="{{ profile.user.username }}" style="padding: 20px 20px 5px 20px; width: 250px; height: 250px;">
        {% else %}
            <img src="{% static 'images/default-avatar.jpg' %}" alt="avatar" style="padding: 20px 20px 5px 20px; width: 250px; height: 250px;">
        {% endif %}

        <div class="profile-column-container" style="min-width: 67%;">
            <a class="simple-text profile-username" style="font-size: 1.5rem; padding: 20px 20px 0 0">{{ profile.user.username }}</a>
            <hr style="color: black; width: 100%;">
            <a class="simple-text profile-description" style="font-size: 1.3rem; padding: 0 20px 20px 0">
                {% if profile.bio %}
                    {{ profile.bio }}
                {% else %}
                    <span data-lang-ru="Описание отсутствует" data-lang-en="No description">Описание отсутствует</span>
                {% endif %}
            </a>
            <a class="simple-text profile-rating" style="font-size: 1rem; margin-top: auto; padding: 20px 20px 5px 0"
               data-lang-ru="Рейтинг: {{ profile.rating|default:"0"|floatformat:0 }}/5"
               data-lang-en="Rating: {{ profile.rating|default:"0"|floatformat:0 }}/5">
                Рейтинг: {{ profile.rating|default:"0"|floatformat:0 }}/5
            </a>
        </div>
    </div>

    <hr style="color:black; width:96%;">

    <div class="profile-row-container" style="gap:20px; padding:25px 20px 0 20px;">
        <button class="profile-button" id="bttn-1" data-lang-ru="руководства" data-lang-en="guides">руководства</button>
        <button class="profile-button" id="bttn-2" data-lang-ru="объявления" data-lang-en="announcements">объявления</button>
        {% if user == profile.user %}
        <form action="{% url 'profile_edit' %}" method="get" style="margin:0; margin-left:auto;">
            <button class="profile-button" id="bttn-3" data-lang-ru="редактировать" data-lang-en="edit">редактировать</button>
        </form>
        {% endif %}
    </div>

    <div id="guides-container" class="profile-row-container" style="padding:10px 20px; gap:20px;">
        {% if guides %}
            {% for guide in guides %}
                <a href="{% url 'guide_detail' guide.id %}" class="guide-link">
                    <div class="guide-element">
                        {% if guide.image %}
                            <img src="{{ guide.image.url }}" class="image-element" alt="{{ guide.title }}">
                        {% else %}
                            <img src="{% static 'images/default-avatar.jpg' %}" class="image-element" alt="guide">
                        {% endif %}
                        <span class="text-element" style="margin:auto;">{{ guide.title }}</span>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <a style="margin:auto;" data-lang-ru="У пользователя нет руководств" data-lang-en="User has no guides">У пользователя нет руководств</a>
        {% endif %}
    </div>
    <div id="announcements-container" class="profile-row-container" style="padding:10px 20px; gap:20px;">
        {% if announcements %}
            {% for ann in announcements %}
                <a class="announcement-link" href="{% url 'announcement_detail' ann.id %}">
                    <div class="guide-element">
                        {% if ann.image %}
                            <img src="{{ ann.image.url }}" class="image-element" alt="{{ ann.title }}">
                        {% else %}
                            <img src="{% static 'images/default-announcement.png' %}" class="image-element" alt="announcement">
                        {% endif %}
                        <span class="text-element" style="margin:auto;">{{ ann.title }}</span>
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <a style="margin:auto;" data-lang-ru="У пользователя нет объявлений" data-lang-en="User has no announcements">У пользователя нет объявлений</a>
        {% endif %}
    </div>

    <div style="margin: 20px auto; width: 95%;">
        <a class="simple-text" style="font-size: 1.3rem; margin-bottom: 10px; display: block;">
            История активности
        </a>
        <div id="activity-container">
            {% if request.user.activities.exists %}
                {% for act in request.user.activities.all %}
                    <div class="activity-item">
                        <span style="color: #666;">{{ act.created_at|date:"H:i" }}</span>
                        <strong>{{ act.get_action_display }}</strong>
                        <span>{{ act.get_target_type_display|lower }}</span>
                        "<em>{{ act.target_title }}</em>"
                    </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; color: #888; font-style: italic; padding: 20px 0;">
                    Нет активности
                </div>
            {% endif %}
        </div>
    </div>

    <hr style="color:black; width:96%; margin:20px auto;">
    <a class="simple-text" style="line-height:20px;"
       data-lang-ru="Отзывы о {{ profile.user.username }}"
       data-lang-en="Reviews about {{ profile.user.username }}">Отзывы о {{ profile.user.username }}</a>

    <div id="reviews-container" class="profile-column-container" style="gap:20px;">
        {% if reviews %}
            {% for review in reviews %}
                <div class="profile-column-container" style="justify-content:left; padding:10px 20px; background-color:ghostwhite; border-radius:5px; box-shadow:0 1px 2px; width:75%; margin:auto;">
                    <div class="profile-row-container">
                        {% if review.author.profile.avatar %}
                            <img src="{{ review.author.profile.avatar.url }}" class="rec_avatar" alt="{{ review.author.username }}">
                        {% else %}
                            <img src="{% static 'images/default-avatar.jpg' %}" class="rec_avatar" alt="avatar">
                        {% endif %}
                        <div class="profile-column-container">
                            <a class="simple-text" style="font-size:1rem; padding-left:10px;">{{ review.author.username }}</a>
                            <a class="simple-text" style="font-size:0.8rem; color:#444; padding-left:10px;">{{ review.created_at|date:"d.m.Y" }}</a>
                        </div>
                    </div>
                    <a class="simple-text" style="font-size:1rem; padding-top:5px;">{{ review.text }}</a>
                </div>
            {% endfor %}
        {% else %}
            <a style="margin:auto;" data-lang-ru="Пока нет отзывов" data-lang-en="No reviews yet">Пока нет отзывов</a>
        {% endif %}
    </div>

    <hr style="color:black; width:96%; margin:20px auto;">
    {% if user.is_authenticated and user != profile.user %}
    <a class="simple-text" data-lang-ru="Напишите свой отзыв" data-lang-en="Write your review">Напишите свой отзыв</a>
    <form method="POST" class="profile-column-container">
        {% csrf_token %}
        <textarea class="textarea_profile" name="text" placeholder="Начните печатать здесь"
                  data-placeholder-ru="Начните печатать здесь"
                  data-placeholder-en="Start typing here"></textarea>
        <a id="error" hidden class="simple-text" style="font-size:1rem; margin:10px auto; color:red;"
           data-lang-ru="Отзыв не может быть пустым!"
           data-lang-en="Review cannot be empty!">Отзыв не может быть пустым!</a>
        <div class="profile-row-container" style="margin:auto; gap:10px;">
            <button id="response_bttn" class="profile-button" style="width:20%; margin-bottom:20px; height:40px; border:none; box-shadow:0 1px 3px #424242;" type="submit"
                    data-lang-ru="Отправить"
                    data-lang-en="Send">Отправить</button>
        </div>
    </form>
    {% endif %}
</div>

<footer class="footer">
    <div class="footer-container">
        <table class="simple-text" style="width:100%; height:100%; color:lightgray; font-size:1rem;">
            <tr>
                <td colspan="3" style="width:33%;">
                    <a href="https://www.sfu.ru/ru" class="nav-group-left" style="text-decoration:none; color:lightgray; margin-top:5px; font-size:1.25rem;"
                       data-lang-ru="Сибирский Федеральный Университет"
                       data-lang-en="Siberian Federal University">Сибирский Федеральный Университет</a>
                </td>
                <td style="text-align:right;">
                    <p class="nav-group-right" style="margin-top:5px; font-size:1.25rem;">@skill_issue 2025</p>
                </td>
            </tr>
            <tr>
                <td><p style="text-align:left;">@bukohm</p></td>
                <td><p style="text-align:center;">@hoolkayyy</p></td>
                <td><p style="text-align:right;">@K1rkaSs</p></td>
            </tr>
        </table>
    </div>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', async function() {
    const guidesBtn = document.getElementById("bttn-1");
    const announcementsBtn = document.getElementById("bttn-2");
    const guidesContainer = document.getElementById("guides-container");
    const announcementsContainer = document.getElementById("announcements-container");

    guidesContainer.style.display = "flex";
    announcementsContainer.style.display = "none";
    guidesBtn.classList.add("active-btn");
    announcementsBtn.classList.remove("active-btn");

    guidesBtn.addEventListener("click", function() {
        guidesContainer.style.display = "flex";
        announcementsContainer.style.display = "none";
        guidesBtn.classList.add("active-btn");
        announcementsBtn.classList.remove("active-btn");
    });

    announcementsBtn.addEventListener("click", function() {
        guidesContainer.style.display = "none";
        announcementsContainer.style.display = "flex";
        guidesBtn.classList.remove("active-btn");
        announcementsBtn.classList.add("active-btn");
    });
        const textarea = document.querySelector('textarea');
        const error_text = document.getElementById('error');
        const button = document.getElementById('response_bttn');

        if (button && textarea && error_text) {
            button.addEventListener('click', textarea_check);
        }

        function textarea_check(event) {
            const lang = localStorage.getItem('lang') || 'RU';
            const errorMsg = lang === 'RU' ? "Отзыв не может быть пустым!" : "Review cannot be empty!";
            if (!textarea.value.trim()) {
                event.preventDefault();
                error_text.textContent = errorMsg;
                error_text.removeAttribute('hidden');
            } else {
                error_text.setAttribute('hidden', 'true');
            }
        }

    const menuContainer = document.getElementById("menu-container");
    if (menuContainer) {
        try{
            const response = await authManager.apiRequest("/api/me/");
            if(response.ok){
                const user = await response.json();
                menuContainer.innerHTML = `<a class="nav-links" href="#" id="logout-btn" style="margin-right:25px;" data-lang-ru="выйти" data-lang-en="log out">выйти</a>`;
                // Применяем язык к новым элементам
                setTimeout(() => {
                    if (typeof applyLanguage === 'function') {
                        applyLanguage(currentLang);
                    }
                }, 100);
                
                const logoutBtn = document.getElementById("logout-btn");
                if (logoutBtn) {
                    logoutBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        authManager.logout();
                    });
                }
            }
        }catch(err){ 
            console.error(err); 
        }
    }

});
</script>
<script src="{% static 'js/auth.js' %}"></script>
<script src="{% static 'js/search.js' %}"></script>
<script src="{% static 'js/toggle_language.js' %}"></script>
</body>
</html>