{% load static %}
<html>
<head>
    <meta charset="UTF-8">
    <title>Skill Issue</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header class="header" id="header">
        <nav class="header-container">
            <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
            <div class="nav-group nav-group-left">
                <a class="nav-links" href="{% url 'guides_list' %}">руководства</a>
                <a class="nav-links">анкеты</a>
            </div>
            <div class="nav-group nav-group-right">
                <div class="search-container">
                    <input class="search" placeholder="поиск руководств, анкет и профилей" id="searchInput">
                    <div class="search-dropdown" id="searchDropdown">
                    </div>
                </div>
                <a class="nav-links">избранное</a>
                <div class="menu-container">
                    <a class="nav-links" href="{% url 'login_page' %}">войти</a>
                    <div class="context-menu">
                        <a href="{% url 'register_page' %}">зарегистрироваться</a>
                        <a href="{% url 'login_page' %}">войти</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="register_container">
        <form id="login_form" style="margin: auto; margin-top: 40px;" class="register_panel" novalidate>
            <p class="simple-text" style="margin: auto; font-size: 2rem">Уже зарегистрированы?</p>
            <p class="simple-text" style="margin: auto; margin-top: -20px; font-size: 1rem">Напомните, кто вы?</p>

            <input class="register_input" type="text" id="login_username" placeholder="введите username" style="margin: auto">
            <input class="register_input" type="password" id="login_password" placeholder="введите пароль" style="margin: auto">

            <div style="height: 20px; margin-top: -30px; margin-bottom: -20px">
                <p id="login_error" class="simple-text" style="font-size:0.8rem"></p>
            </div>

            <button type="submit" class="register_button">войти</button>
            <a href="{% url 'register_page' %}" class="simple-text" style="color: dimgray; font-size: 1rem; margin-top: -20px">зарегистрироваться</a>
        </form>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <table class="simple-text" style="width: 100%; height: 100%; color: lightgray; font-size: 1rem">
                <tr>
                    <td colspan="3" style="width:33%;">
                        <a href="https://www.sfu.ru/ru" class="nav-group-left" style="text-decoration: none; color: lightgray; margin-bottom: auto; margin-top: 5px; font-size: 1.25rem">Сибирский Федеральный Университет</a>
                    <td style="text-align:right">
                        <p class="nav-group-right" style="margin-bottom: auto; margin-top: 5px; font-size: 1.25rem;">@skill_issue 2025</p>
                </tr>
                <tr>
                    <td><p style="text-align:left">@bukohm</p>
                    <td><p style="text-align:center">@hoolkayyy</p>
                    <td><p style="text-align:right">@K1rkaSs</p>
                </tr>
            </table>
        </div>
    </footer>
</body>

<script src="{% static 'js/auth.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('login_form');
    const usernameInput = document.getElementById('login_username');
    const passwordInput = document.getElementById('login_password');
    const error_par = document.getElementById('login_error');

    if (!loginForm) return;

    loginForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username || !password) {
            error_par.textContent = "Заполните все поля";
            return;
        }

        error_par.textContent = '';

        fetch("/api/login/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({username, password}),
            credentials: "include"
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                error_par.textContent = data.error;
            } else if (data.access && data.refresh) {
                // Сохраняем JWT токены
                authManager.setTokens(data.access, data.refresh, {
                    username: data.username,
                    email: data.email
                });
                
                // Перенаправляем на главную страницу
                window.location.href = "{% url 'main_page' %}";
            } else {
                error_par.textContent = "Неожиданный ответ от сервера";
            }
        })
        .catch(err => {
            console.error(err);
            error_par.textContent = "Ошибка сервера";
        });
    });
});
</script>
<script src="{% static 'js/search.js' %}"></script>
</html>
