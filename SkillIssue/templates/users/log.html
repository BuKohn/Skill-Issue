{% load static %}
<html>
<head>
    <meta charset="UTF-8">
    <title>Skill Issue</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header class="header" id="header">
        <nav class="header-container">
            <a class="logo" href="{% url 'main_page' %}">Skill Issue</a>
            <div class="nav-group nav-group-left">
                <a class="nav-links" href="{% url 'guides_list' %}" data-lang-ru="руководства" data-lang-en="guides">руководства</a>
                <a class="nav-links" data-lang-ru="анкеты" data-lang-en="profiles">анкеты</a>
            </div>
            <div class="nav-group nav-group-right">
                <div class="search-container">
                    <input class="search" placeholder="поиск руководств, анкет и профилей" id="searchInput"
                           data-placeholder-ru="поиск руководств, анкет и профилей"
                           data-placeholder-en="search guides, profiles and announcements">
                    <div class="search-dropdown" id="searchDropdown">
                    </div>
                </div>
                <a class="nav-links" data-lang-ru="избранное" data-lang-en="favorites">избранное</a>
                <a class="nav-links" id="language-toggle" href="#" onclick="toggleLanguage(event)" title="Сменить язык">RU</a>
                <div class="menu-container">
                    <a class="nav-links" href="{% url 'login_page' %}" data-lang-ru="войти" data-lang-en="log in">войти</a>
                    <div class="context-menu">
                        <a href="{% url 'register_page' %}" data-lang-ru="зарегистрироваться" data-lang-en="register">зарегистрироваться</a>
                        <a href="{% url 'login_page' %}" data-lang-ru="войти" data-lang-en="log in">войти</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="register_container">
        <form id="login_form" style="margin: auto; margin-top: 40px;" class="register_panel" novalidate>
            <p class="simple-text" style="margin: auto; font-size: 2rem" data-lang-ru="Уже зарегистрированы?" data-lang-en="Already registered?">Уже зарегистрированы?</p>
            <p class="simple-text" style="margin: auto; margin-top: -20px; font-size: 1rem" data-lang-ru="Напомните, кто вы?" data-lang-en="Remind us who you are?">Напомните, кто вы?</p>

            <input class="register_input" type="text" id="login_username" placeholder="введите username"
                   data-placeholder-ru="введите username"
                   data-placeholder-en="enter username"
                   style="margin: auto">
            <input class="register_input" type="password" id="login_password" placeholder="введите пароль"
                   data-placeholder-ru="введите пароль"
                   data-placeholder-en="enter password"
                   style="margin: auto">

            <div style="height: 20px; margin-top: -30px; margin-bottom: -20px">
                <p id="login_error" class="simple-text" style="font-size:0.8rem"></p>
            </div>

            <button type="submit" class="register_button" data-lang-ru="войти" data-lang-en="log in">войти</button>
            <a href="{% url 'register_page' %}" class="simple-text" style="color: dimgray; font-size: 1rem; margin-top: -20px"
               data-lang-ru="зарегистрироваться" data-lang-en="register">зарегистрироваться</a>
        </form>
    </div>

    <footer class="footer">
        <div class="footer-container">
            <table class="simple-text" style="width: 100%; height: 100%; color: lightgray; font-size: 1rem">
                <tr>
                    <td colspan="3" style="width:33%;">
                        <a href="https://www.sfu.ru/ru" class="nav-group-left" style="text-decoration: none; color: lightgray; margin-bottom: auto; margin-top: 5px; font-size: 1.25rem"
                           data-lang-ru="Сибирский Федеральный Университет"
                           data-lang-en="Siberian Federal University">Сибирский Федеральный Университет</a>
                    </td>
                    <td style="text-align:right">
                        <p class="nav-group-right" style="margin-bottom: auto; margin-top: 5px; font-size: 1.25rem;">@skill_issue 2025</p>
                    </td>
                </tr>
                <tr>
                    <td><p style="text-align:left">@bukohm</p>
                    </td>
                    <td><p style="text-align:center">@hoolkayyy</p>
                    </td>
                    <td><p style="text-align:right">@K1rkaSs</p>
                    </td>
                </tr>
            </table>
        </div>
    </footer>
</body>

<script src="{% static 'js/auth.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('login_form');
    const usernameInput = document.getElementById('login_username');
    const passwordInput = document.getElementById('login_password');
    const error_par = document.getElementById('login_error');

    if (!loginForm) return;

    loginForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();

        const lang = localStorage.getItem('lang') || 'RU';
        const errorMsg = lang === 'RU' ? "Заполните все поля" : "Please fill in all fields";

        if (!username || !password) {
            error_par.textContent = errorMsg;
            return;
        }

        error_par.textContent = '';

        fetch("/api/login/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({username, password}),
            credentials: "include"
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(data => {
                    throw new Error(data.error || (lang === 'RU' ? `Ошибка ${res.status}` : `Error ${res.status}`));
                });
            }
            return res.json();
        })
        .then(data => {
            if (data.access && data.refresh) {
                authManager.setTokens(data.access, data.refresh, {
                    username: data.username,
                    email: data.email
                });
                window.location.href = "{% url 'main_page' %}";
            } else {
                error_par.textContent = lang === 'RU' ? "Неожиданный ответ от сервера" : "Unexpected server response";
            }
        })
        .catch(err => {
            console.error(err);
            error_par.textContent = err.message || (lang === 'RU' ? "Ошибка сервера" : "Server error");
        });
    });
});
</script>
<script src="{% static 'js/search.js' %}"></script>
<script src="{% static 'js/toggle_language.js' %}"></script>
</html>